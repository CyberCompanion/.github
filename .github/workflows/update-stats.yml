name: Mise √† jour des statistiques
on:
  schedule:
    # Ex√©cution le lundi et jeudi √† 8h00 UTC
    - cron: "0 8 * * 1,4"
  workflow_dispatch: # Permet de d√©clencher manuellement le workflow
jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout du d√©p√¥t
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: R√©cup√©ration des statistiques Discord
        id: get-stats
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          MECHANIC_GUILD_ID: ${{ secrets.MECHANIC_GUILD_ID }}
          NUIT_ETOILEE_GUILD_ID: ${{ secrets.NUIT_ETOILEE_GUILD_ID }}
        run: |
          # R√©cup√©ration des statistiques via l'API Discord
          RESPONSE=$(curl -s -H "Authorization: Bot $DISCORD_TOKEN" \
            -H "Content-Type: application/json" \
            https://discord.com/api/v10/users/@me/guilds)

          # Nombre de serveurs
          SERVERS=$(echo "$RESPONSE" | jq '. | length')
          echo "servers=$SERVERS" >> $GITHUB_OUTPUT

          # Calcul du nombre total d'utilisateurs
          TOTAL_USERS=0
          for guild_id in $(echo "$RESPONSE" | jq -r '.[].id'); do
            GUILD_DATA=$(curl -s -H "Authorization: Bot $DISCORD_TOKEN" \
              -H "Content-Type: application/json" \
              "https://discord.com/api/v10/guilds/$guild_id?with_counts=true")
            MEMBERS=$(echo "$GUILD_DATA" | jq -r '.approximate_member_count // 0')
            TOTAL_USERS=$((TOTAL_USERS + MEMBERS))
            sleep 0.5  # Respecter les rate limits de Discord
          done
          echo "users=$TOTAL_USERS" >> $GITHUB_OUTPUT

          # R√©cup√©ration des membres des serveurs communautaires
          MECHANIC_DATA=$(curl -s -H "Authorization: Bot $DISCORD_TOKEN" \
            "https://discord.com/api/v10/guilds/$MECHANIC_GUILD_ID?with_counts=true")
          MECHANIC_MEMBERS=$(echo "$MECHANIC_DATA" | jq -r '.approximate_member_count // 0')
          echo "mechanic_members=$MECHANIC_MEMBERS" >> $GITHUB_OUTPUT

          NUIT_DATA=$(curl -s -H "Authorization: Bot $DISCORD_TOKEN" \
            "https://discord.com/api/v10/guilds/$NUIT_ETOILEE_GUILD_ID?with_counts=true")
          NUIT_MEMBERS=$(echo "$NUIT_DATA" | jq -r '.approximate_member_count // 0')
          echo "nuit_members=$NUIT_MEMBERS" >> $GITHUB_OUTPUT

          echo "‚úÖ Serveurs: $SERVERS | Utilisateurs: $TOTAL_USERS"
          echo "‚úÖ The Mechanic: $MECHANIC_MEMBERS | Nuit √âtoil√©e: $NUIT_MEMBERS"

      - name: Mise √† jour du README
        env:
          SERVERS: ${{ steps.get-stats.outputs.servers }}
          USERS: ${{ steps.get-stats.outputs.users }}
          MECHANIC_MEMBERS: ${{ steps.get-stats.outputs.mechanic_members }}
          NUIT_MEMBERS: ${{ steps.get-stats.outputs.nuit_members }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const readmePath = path.join(process.cwd(), 'profile', 'README.md');
          let content = fs.readFileSync(readmePath, 'utf8');

          // R√©cup√©ration des statistiques depuis les variables d'environnement
          const servers = parseInt(process.env.SERVERS) || 75;
          const users = parseInt(process.env.USERS) || 13800;
          const mechanicMembers = parseInt(process.env.MECHANIC_MEMBERS) || 2400;
          const nuitMembers = parseInt(process.env.NUIT_MEMBERS) || 1800;

          // Formatage des nombres avec arrondi √† la centaine
          const serversFormatted = servers + '+';
          const roundedUsers = Math.round(users / 100) * 100;
          const usersFormatted = roundedUsers.toLocaleString('fr-FR').replace(/\s/g, ' ') + '+';
          const roundedMechanic = Math.round(mechanicMembers / 100) * 100;
          const mechanicFormatted = roundedMechanic.toLocaleString('fr-FR').replace(/\s/g, ' ');
          const roundedNuit = Math.round(nuitMembers / 100) * 100;
          const nuitFormatted = roundedNuit.toLocaleString('fr-FR').replace(/\s/g, ' ');

          // Mise √† jour des stats globales
          const statsPattern = /(## üìä Statistiques\s+<div align="center">\s+<table>\s+<tr>\s+<td><strong>Serveurs<\/strong><\/td>\s+<td>)[^<]+(<\/td>\s+<\/tr>\s+<tr>\s+<td><strong>Utilisateurs<\/strong><\/td>\s+<td>)[^<]+(<\/td>)/s;
          content = content.replace(statsPattern, `$1${serversFormatted}$2${usersFormatted}$3`);

          // Mise √† jour de The Mechanic Community
          content = content.replace(
            /(\*\*üèéÔ∏è The Mechanic Community\*\* - Communaut√© automobile avec plus de )[0-9 ]+( membres)/,
            `$1${mechanicFormatted}$2`
          );

          // Mise √† jour de Nuit √âtoil√©e
          content = content.replace(
            /(\*\*‚ú® Nuit Etoil√©e\*\* - Communaut√© de passionn√©s de musique \(\+ de )[0-9 ]+( membres\))/,
            `$1${nuitFormatted}$2`
          );

          fs.writeFileSync(readmePath, content, 'utf8');
          console.log('‚úÖ Statistiques mises √† jour:');
          console.log(`   Serveurs: ${serversFormatted}`);
          console.log(`   Utilisateurs: ${usersFormatted}`);
          console.log(`   The Mechanic: ${mechanicFormatted} membres`);
          console.log(`   Nuit √âtoil√©e: ${nuitFormatted} membres`);
          EOF

      - name: Commit et push des modifications
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          if git diff --quiet; then
            echo "Aucune modification √† commiter"
          else
            git add profile/README.md
            git commit -m "ü§ñ Mise √† jour automatique des statistiques - $(date +'%d/%m/%Y')"
            git push
            echo "‚úÖ Modifications publi√©es avec succ√®s"
          fi
