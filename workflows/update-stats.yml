name: Mise Ã  jour des statistiques

on:
  schedule:
    # ExÃ©cution le lundi et jeudi Ã  8h00 UTC
    - cron: "0 8 * * 1,4"
  workflow_dispatch: # Permet de dÃ©clencher manuellement le workflow

jobs:
  update-stats:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: RÃ©cupÃ©ration des statistiques Discord
        id: get-stats
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
        run: |
          # RÃ©cupÃ©ration des statistiques via l'API Discord
          RESPONSE=$(curl -s -H "Authorization: Bot $DISCORD_TOKEN" \
            -H "Content-Type: application/json" \
            https://discord.com/api/v10/users/@me/guilds)

          # Nombre de serveurs
          SERVERS=$(echo "$RESPONSE" | jq '. | length')
          echo "servers=$SERVERS" >> $GITHUB_OUTPUT

          # Calcul du nombre total d'utilisateurs
          TOTAL_USERS=0
          for guild_id in $(echo "$RESPONSE" | jq -r '.[].id'); do
            GUILD_DATA=$(curl -s -H "Authorization: Bot $DISCORD_TOKEN" \
              -H "Content-Type: application/json" \
              "https://discord.com/api/v10/guilds/$guild_id?with_counts=true")
            MEMBERS=$(echo "$GUILD_DATA" | jq -r '.approximate_member_count // 0')
            TOTAL_USERS=$((TOTAL_USERS + MEMBERS))
            sleep 0.5  # Respecter les rate limits de Discord
          done

          echo "users=$TOTAL_USERS" >> $GITHUB_OUTPUT
          echo "âœ… Serveurs: $SERVERS | Utilisateurs: $TOTAL_USERS"

      - name: Mise Ã  jour du README
        env:
          SERVERS: ${{ steps.get-stats.outputs.servers }}
          USERS: ${{ steps.get-stats.outputs.users }}
        run: |
          # Script de mise Ã  jour du README
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');

          const readmePath = path.join(process.cwd(), 'profile', 'README.md');
          let content = fs.readFileSync(readmePath, 'utf8');

          // RÃ©cupÃ©ration des statistiques depuis les variables d'environnement
          const servers = parseInt(process.env.SERVERS) || 75;
          const users = parseInt(process.env.USERS) || 13800;

          // Formatage des nombres
          const serversFormatted = servers + '+';
          const usersFormatted = users.toLocaleString('fr-FR').replace(/\s/g, ' ') + '+';

          // Regex pour trouver et remplacer uniquement les serveurs et utilisateurs
          const statsPattern = /(## ðŸ“Š Statistiques\s+<div align="center">\s+<table>\s+<tr>\s+<td><strong>Serveurs<\/strong><\/td>\s+<td>)[^<]+(<\/td>\s+<\/tr>\s+<tr>\s+<td><strong>Utilisateurs<\/strong><\/td>\s+<td>)[^<]+(<\/td>)/s;

          content = content.replace(
            statsPattern,
            `$1${serversFormatted}$2${usersFormatted}$3`
          );

          fs.writeFileSync(readmePath, content, 'utf8');
          console.log('âœ… Statistiques mises Ã  jour:');
          console.log(`   Serveurs: ${serversFormatted}`);
          console.log(`   Utilisateurs: ${usersFormatted}`);
          EOF

      - name: Commit et push des modifications
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet; then
            echo "Aucune modification Ã  commiter"
          else
            git add profile/README.md
            git commit -m "ðŸ¤– Mise Ã  jour automatique des statistiques - $(date +'%d/%m/%Y')"
            git push
            echo "âœ… Modifications publiÃ©es avec succÃ¨s"
          fi
